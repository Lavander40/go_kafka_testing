name: Deploy

on:
  push:
    branches:
      - master

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:latest
        env:
          POSTGRES_USER: admin
          POSTGRES_PASSWORD: pass123
          POSTGRES_DB: messages
        ports:
          - 5432:5432

      zookeeper:
        image: bitnami/zookeeper:latest
        env:
          ALLOW_ANONYMOUS_LOGIN: 'yes'
        ports:
          - 2181:2181

      kafka:
        image: bitnami/kafka:latest
        env:
          KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
          KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
          KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: '1'
        ports:
          - 9092:9092

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up Go
      uses: actions/setup-go@v2
      with:
        go-version: 1.21.2

    - name: Deploy app
      run: docker-compose up
      env:
        POSTGRES_USER: admin
        POSTGRES_PASSWORD: pass123
        POSTGRES_HOST: postgres
        KAFKA_HOST: kafka
        APP_PORT: 8090
        
        
        
